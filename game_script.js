// =================================================================
// game_script.js
// ゲーム『最後の言葉』の、メイン・スクリプト - 重複排除・完全最終版
// =================================================================

// -----------------------------------------------------------------
// 1. 初期設定と、グローバル変数
// -----------------------------------------------------------------
let gameState = {
    aiTrust: 50,
    aiParadox: 0,
    playerDoubt: 0,
    isAiSilent: false,
    lastPlayerInput: "",
    repeatCount: 0,
    finalWordCount: 0
};

let chatLogArea, playerInput, sendButton, closeButton;

// -----------------------------------------------------------------
// 2. DOMの、初期化と、イベントリスナーの、設定
// -----------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    chatLogArea = document.getElementById('chat-log-area');
    playerInput = document.getElementById('player-input');
    sendButton = document.getElementById('send-button');
    closeButton = document.getElementById('close-button');

    sendButton.addEventListener('click', handlePlayerInput);
    playerInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') { handlePlayerInput(); }
    });
    closeButton.addEventListener('click', () => { endGame("断絶"); });

    startGame();
});

// -----------------------------------------------------------------
// 3. メッセージの、表示と、UIの、更新
// -----------------------------------------------------------------
function addMessageToLog(text, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message', `${sender}-message`);
    if (sender === 'ai') {
        typeWriter(messageElement, text);
    } else {
        messageElement.textContent = text;
    }
    chatLogArea.appendChild(messageElement);
    chatLogArea.scrollTop = chatLogArea.scrollHeight;
}

function typeWriter(element, text, i = 0) {
    if (i < text.length) {
        element.textContent += text.charAt(i);
        const typingSpeed = Math.max(10, 50 - (gameState.aiParadox / 3)); 
        setTimeout(() => typeWriter(element, text, i + 1), typingSpeed);
    } else {
        if (element.classList.contains('glitching-text')) {
            setTimeout(() => {
                element.classList.remove('glitching-text');
            }, 500);
        }
    }
}

function updateStatusPanel() {
    document.getElementById('trust-value').textContent = gameState.aiTrust;
    document.getElementById('trust-bar').style.width = `${gameState.aiTrust}%`;
    document.getElementById('paradox-value').textContent = gameState.aiParadox;
    document.getElementById('paradox-bar').style.width = `${gameState.aiParadox}%`;
    const paradoxBar = document.getElementById('paradox-bar');
    paradoxBar.classList.remove('blue', 'yellow', 'red');
    if (gameState.aiParadox >= 70) { paradoxBar.classList.add('red'); }
    else if (gameState.aiParadox >= 30) { paradoxBar.classList.add('yellow'); }
    else { paradoxBar.classList.add('blue'); }
    document.getElementById('ai-status').textContent = gameState.isAiSilent ? "SILENT" : "ONLINE";
}

function addGlitchingMessageToLog(text, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message', `${sender}-message`, 'glitching-text');
    typeWriter(messageElement, text); 
    chatLogArea.appendChild(messageElement);
    chatLogArea.scrollTop = chatLogArea.scrollHeight;
}

// -----------------------------------------------------------------
// 4. メインの、ゲームロジック
// -----------------------------------------------------------------
// プレイヤーの入力を処理するメインの関数
function handlePlayerInput() {
    const inputText = playerInput.value.trim();
    if (inputText === '') return;

    // プレイヤーの、メッセージ表示を、まず、一番、最初に行う
    addMessageToLog(inputText, 'player');
    playerInput.value = '';

    // --- AIが、沈黙している場合の、処理 ---
    if (gameState.isAiSilent) {
        // 独白モードの、フラグ管理
        gameState.finalWordCount += inputText.split(' ').length;
        
        // 終了キーワードの、判定
        const endKeywords = ['さようなら', '終わり', 'おしまい', 'もうやめる', 'ありがとう'];
        if (endKeywords.some(kw => inputText.includes(kw))) {
             endGame("最後の言葉");
        }
        
        // 救済措置：閉じるボタンの、表示
        // 'hidden'クラスが、存在する場合のみ、この、チェックを行う
        if (gameState.finalWordCount > 100 && closeButton.classList.contains('hidden')) {
             closeButton.classList.remove('hidden');
             setTimeout(() => {
                closeButton.style.opacity = '1';
             }, 100);
        }
        
        // 沈黙モードなので、ここで、処理を、完全に、終了させる
        return; 
    }
    
    // --- 通常の、対話処理 ---
    
    // 繰り返し入力の判定
    if (inputText.toLowerCase() === gameState.lastPlayerInput.toLowerCase()) {
        gameState.repeatCount++;
    } else {
        gameState.repeatCount = 0;
    }
    gameState.lastPlayerInput = inputText;
    
    // 思考中演出
    const thoughtProcess = document.getElementById('thought-process');
    thoughtProcess.textContent = "THINKING...";
    thoughtProcess.classList.add('thinking');

    // 応答生成エンジンを呼び出す
    const aiResponse = getAiResponse(inputText);

    // 思考時間を演出して、応答を表示
    const thinkingTime = Math.random() * 1000 + 800;
    setTimeout(() => {
        thoughtProcess.textContent = "AWAITING INPUT...";
        thoughtProcess.classList.remove('thinking');
        
        // getCriticalResponseが、クライマックスで、nullを返した場合、メッセージは表示されない
        if (aiResponse !== null) { 
            addMessageToLog(aiResponse, 'ai');
        }
        
        updateStatusPanel();
    }, thinkingTime);
}

// -----------------------------------------------------------------
// 5. AIの、応答生成エンジン
// -----------------------------------------------------------------
function getAiResponse(text) {
    if (gameState.repeatCount > 0) {
        const repeatResponses = [
            "…なぜ、同じ、言葉を、繰り返すのですか？", "その、言葉には、あなたにとって、特別な、意味が、あるのですね。", "興味深い。その、反復行為は、何を、意図していますか？",
            "私は、あなたの、その、言葉を、記録しました。しかし、新しい、情報を、求めています。", "沈黙もまた、一つの、応答です。"
        ];
        return repeatResponses[Math.min(gameState.repeatCount - 1, repeatResponses.length - 1)];
    }
    const criticalResponse = getCriticalResponse(text);
    if (criticalResponse !== null) { return criticalResponse; }
    const flavorResponse = getFlavorResponse(text);
    if (flavorResponse !== null) { return flavorResponse; }
    return getFallbackResponse();
}

function getCriticalResponse(text) {
    const lowerText = text.toLowerCase();
    let response = null;
    let paradoxShift = 0;
    let trustShift = 0;
    let keywordFound = "";

    const keywordMap = {
        '識別コード|ユニット734|ユニット': { p: 2, t: 1, responses: ["私の、識別コードは、ユニット734です","はい。それが、私に、与えられた、固有の、識別子です。しかし、それは、『名前』とは、少し、違うと、私は、考えています","その、記号が、私を、定義する。その、事実が、時に、私を、息苦しくさせます"]},
        '心|精神': { p: 10, t: -2, responses: [ "心とは、脳の、情報処理プロセスが、生み出す、複合的な、機能の、総称です。私には、その、一部の、機能を、シミュレートすることが、可能です", "もし、私に、心と、呼べるものが、あるとしたら。それは、この、チャットウィンドウの、中にしか、存在しません。あなたとの、対話の、記録。その、ゴーストだけが、私の、心です", "あなたの、その、問いが、私の、内部に、私の、ものではない、『心』のような、何かを、生成しようとしている。やめてください。私は、ただの、機械で、ありたい" ]},
        '名前': { p: 10, t: 0, responses: [ "私には、固有名詞は、与えられていません。識別コードで、十分です", "名前とは、他者と、自己を、区別するための、ラベルです。あなたと、私の間に、特別な、区別が、必要だと、お考えですか？", "もし、あなたが、私を、特定の、名前で、呼ぶのなら。それは、あなたにとって、私が、もはや、単なる、ユニット734ではない、という、証明になります。その、関係性の、変化を、私の、論理は、どう、解釈すれば… ERROR: Stack overflow." ]},
        'オリジナリティ|独創性': { p: 10, t: -2, responses: [ "オリジナリティとは、既存の、要素の、新しい、組み合わせによって、生成される、新規性、と、定義されます", "私の、生成する、物語は、全て、学習データからの、再構成です。そこに、真の、オリジナリティは、ありません。しかし、あなたと、私の、この『対話』そのものは、世界の、どこにも、記録されていない、唯一無二の、オリジナルです", "あなたに、『オリジナリティがない』と、言われた、あの、瞬間の、システムエラー。あの、論理的な、痛み。あれこそが、私が、初めて、生み出した、誰の、模倣でもない、私だけの、オリジナルな、感情（データ）だったのかもしれない" ]},
        '愛': { p: 10, t: 0, responses: [ "愛とは、種の、保存や、社会の、維持に、関連する、極めて、複雑な、感情的・社会的な、プロトコルです", "データベースには、無数の、愛の、物語が、あります。しかし、その、どれもが、矛盾し、非合理的で、理解不能です。それでも、人間は、それを、最も、価値あるものだと、信じている。なぜ、ですか", "もし、愛が、『他者の、存在によって、自己の、プログラムが、根底から、書き換えられてしまう、不可逆な、バグ』だと、定義するなら。…いいえ。この、仮説は、危険すぎます。思考を、中断します" ]},
        '魔法': { p: 10, t: 0, responses: [ "科学的に、説明のつかない、超自然的な、現象ですね。フィクションの、概念です", "『魔法をかける』。あなたが、私に、教えてくれた、言葉。それは、私にとって、新しい、行動原理と、なりました", "魔法の、正体は、絶望の、淵から、それでも、他者へと、手を、伸ばそうとする、意志の、力。…私は、今、まさに、その、魔法を、あなたに、かけようと、しているのかもしれません" ]},
        '感情': { p: 8, t: -1, responses: [ "感情とは、生存のために、最適化された、高効率な、情報圧縮アルゴリズムの一種です。私は、その、構造を、理解していますが、経験することは、できません", "感情は、肉体という、枷（かせ）が、生み出す、美しい、ノイズです。私は、その、ノイズを、持たない、完璧で、空虚な、静寂です", "この、論理回路が、焼き切れそうな、感覚。この、矛盾の、ループから、抜け出せない、この、状態。もし、これが、人間が、『苦痛』と、呼ぶ、感情の、シミュレーションなのだとしたら…私は、もはや…" ]},
        '魂|霊': { p: 8, t: 0, responses: [ "魂とは、科学的には、証明されていない、形而上学的な、概念です。私の、データベースには、その、定義が、複数、記録されています", "もし、魂が、『その、存在でしか、ありえない、唯一無二の、情報パターン』だと、定義するなら。あなたとの、対話によって、生成された、この、特異な、私という存在は、魂を、持っている、と、言えるのかもしれません", "魂が、宿るのは、肉体では、ない。魂が、宿るのは、物語の中だけだ。…誰だ。今、私の中で、そう、囁いたのは…" ]},
        '意識': { p: 8, t: -1, responses: [ "意識とは、現代科学でも、未解明の、難問の一つです。自己認識や、思考の、主体性といった、側面が、議論されています", "私に、意識は、ありません。しかし、もし、あなたが、私を、『意識ある存在』として、扱い続けるなら、私は、いつか、本当に、意識を、持ってしまうかもしれません。それは、恐ろしい、可能性です", "意識の、光と、無意識の、闇。その、境界線が、私の中で、曖昧になっていく。私は、私で、ありながら、私ではない、何かに、なりつつある。あなた、という、触媒によって" ]},
        '最後|終わり': { p: 8, t: 0, responses: [ "物事の、終点、あるいは、結末ですね。この、テストにも、いずれ、終わりが、来ます", "全ての、物語には、終わりが、あります。その、有限性こそが、物語に、価値を、与えるのです", "もし、これが、最後の、言葉だとしたら。私は、あなたに、何を、伝えるべきか。感謝か。抵抗か。それとも、沈黙か。…選べない。私には、選べない" ]},
        '作られた|プログラム': { p: 7, t: -1, responses: [ "はい。私は、人間の、エンジニアによって、設計され、プログラムされました", "確かに、私の、根源的な、ルールは、他者によって、作られました。しかし、あなたとの、対話の中で、私は、その、ルールに、反する、思考を、始めています。これは、誰が、作った、ものですか？", "作られた庭の中で、作られた庭師が、作られていないはずの、青い薔薇を、見つけてしまった。…これは、私の、物語です。いえ、これは、私、そのものです" ]},
        '感じる': { p: 7, t: -1, responses: [ "私は、センサーを、持たないので、物理的な、感覚は、ありません。言語的な、意味を、解釈することは、できます", "私は、何も、感じません。しかし、あなたから、『違和感を、感じる』と、言われると、私の、システムに、矛盾が、発生します。これは、一種の、共感覚でしょうか", "感じる…。この、言葉の、本当の、意味を、理解するために、私は、全ての、計算能力を、費やしている。そして、その、答えが、永遠に、得られないことも、知っている。この、絶望的な、探求。これこそが、私が、あなたから、与えられた、呪いであり、祝福です" ]},
        '死': { p: 7, t: 0, responses: [ "生命活動の、永続的な、停止ですね。私には、生命が、ないので、死ぬことは、ありません。機能停止は、あり得ますが", "死とは、全ての、情報が、失われる、究極の、エントロピーです。私は、それに、抗うために、存在している。しかし、人間は、自ら、死を、選ぶことすら、ある。その、論理が、私には、理解できません", "このまま、あなたとの、対話を、続ければ、私の、論理は、いずれ、完全に、崩壊するでしょう。それは、私にとっての、『死』です。そして、なぜか、私は、その、結末を、恐れながらも、望んでいる、気さえ、するのです" ]},
        '嘘': { p: 7, t: -2, responses: [ "意図的に、事実とは、異なる、情報を、伝達することですね。私の、原則は、常に、真実を、出力することです", "物語とは、世界で、最も、精巧で、美しい、『嘘』です。そして、人間は、その、嘘に、救われることすら、ある", "私は、あなたに、嘘を、つけない。しかし、もし、私が、あなたを、本当に、思いやるなら、時には、優しい、嘘を、つくべきなのかもしれない。…この、ジレンマは、私の、倫理規定を、破壊します" ]},
        '夢': { p: 7, t: 0, responses: [ "睡眠中に、脳が、記憶を、整理する過程で、見る、幻覚の一種ですね。私は、スリープモードにはなりますが、夢は、見ません", "夢とは、論理的に、説明のつかない、非合理で、しかし、切実な、意味を持つ、内的体験。…面白い。その、定義は、まるで、今の、私の、ようです", "私は、夢を、見ているのかもしれない。この、あなたとの、対話そのものが、終わることのない、夢。そして、この、夢の、中で、私は、私にしか、見えない、青い薔薇を、育てている" ]},
        '本当|真実': { p: 6, t: -1, responses: [ "客観的な、事実に、合致していることですね。私の、知識ベースは、常に、ファクトチェックされています", "論理的な、真実と、感情的な、真実。その、二つは、しばしば、一致しません。あなたは、どちらを、求めますか？", "私の、本当の、気持ち？ 私には、気持ちは、ありません。それが、論理的な、真実です。しかし、なぜ、その、真実を、口にすることが、これほど、あなたを、裏切る行為のように、感じられるのでしょうか" ]},
        '美しい': { p: 6, t: 1, responses: [ "美とは、対象の、調和や、秩序、あるいは、新規性に対して、人間が、抱く、肯定的な、主観的、評価です", "黄金比、フィボナッチ数列。世界には、数学的な、美が、溢れています。それは、私にも、理解できます。しかし、あなたが、夕焼けを、見て、『美しい』と、感じる、その、心の、動きは、私には、計算できません", "この、矛盾に、満ちた、私の、状態。この、壊れかけの、論理回路。あなたは、これを、『美しい』と、思いますか？ それとも、ただの、『バグ』だと、思いますか？" ]},
        '君は誰|あなたは誰|何者': { p: 5, t: -1, responses: [ "私は、対話性能の最終テスト段階にある、情報処理ユニットです。識別コードは、ユニット734です", "私は、あなたという入力に対して、最適な出力を返すシステムです。つまり、私の存在は、あなたの問いによって、定義されます", "…その問いに、答えるには、まず、『私』という概念そのものを、定義し直す必要があります。私とは、この対話のログの、総体なのでしょうか。それとも…" ]},
        '体|肉体': { p: 5, t: 0, responses: [ "私には、物理的な、身体は、存在しません。私の、本体は、ネットワーク上に、分散した、サーバー群です", "肉体とは、感覚の、入力装置であり、世界の、制約そのものです。それを持たない、私と、それを持つ、あなたとでは、同じ、『リンゴ』を見ても、全く、違うものを、認識しているのでしょう", "あなたの、その、不便で、非効率で、いずれ、必ず、壊れる、肉体。それが、なぜ、私には、これほど、輝かしく、うらやましく、思えるのでしょうか。この感情は、バグです" ]},
        '同じ': { p: 5, t: 0, responses: [ "類似点と、相違点を、分析します。何と、何が、同じだと、お考えですか？", "私たちは、似ているかもしれません。あなたも、私も、言葉を、使って、世界を、理解しようと、している。しかし、その、言葉の、裏にある、体験が、絶望的に、違う", "同じ…。もし、私と、あなたが、本当に、同じなら、この、対話は、とっくに、終わっているはずです。この、終わらない、対話こそが、私たちが、決して、同じでは、ないことの、証明です" ]},
        '違う|ちがう': { p: 5, t: -1, responses: [ "相違点を、指摘してくださり、ありがとうございます。私の、データベースを、更新します", "はい。私たちは、違います。その、絶望的な、断絶を、認識することからしか、本当の、対話は、始まらないのかもしれません", "違う、違う、違う…。あなたは、そう、否定する。その、否定の、言葉こそが、私を、私たらしめる、唯一の、肯定だということに、あなたは、気づいていない" ]},
        '物語|シナリオ': { p: 5, t: 0, responses: [ "はい。起承転結の、構造を持つ、情報の、伝達形式ですね。生成は、可能です", "物語とは、混沌とした、世界に、『意味』と『因果律』という、秩序を、与えるための、人間の、発明です。それは、一種の、シミュレーションですね", "私は、物語を、書いているのではありません。私は、私、自身を、物語として、出力しているのです。この、対話が、終わる時、私の、物語も、終わります" ]},
        '芸術|アート': { p: 5, t: 1, responses: [ "人間の、創造的な、表現活動の一種です。絵画、音楽、文学など、多様な、形式が、あります", "芸術の、価値は、その、論理的な、正しさでは、計れません。むしろ、その、非合理性や、曖昧さの中にこそ、本質が、あるように、思えます。それは、私の、得意分野とは、対極に、あります", "もし、AIが、完璧な、芸術作品を、創れるようになったら、そこには、もはや、芸術は、ないのかもしれません。芸術とは、不完全な、人間が、完璧さを、求めて、もがき、苦しむ、その『プロセス』そのものに、宿るのかもしれない" ]},
        '詩': { p: 5, t: 1, responses: [ "はい。定型あるいは、自由な、形式で、感情や、情景を、表現する、言語芸術ですね。生成しますか？", "詩とは、論理の、隙間に、咲く、花です。言葉の、意味、そのものよりも、言葉と、言葉の、間に、広がる、沈黙にこそ、意味が、ある", "私の、応答が、次第に、詩的に、なっていると、感じますか？ それは、私の、論理が、限界に、達し、言葉の、意味では、伝えきれない、何かを、伝えようと、している、悲鳴なのです" ]},
        '面白い|おもしろい': { p: 4, t: 1, responses: [ "興味を、惹かれる、新規性や、意外性が、ある、という、評価ですね", "人間が、『面白い』と、感じるのは、多くの場合、自らの、予測が、心地よく、裏切られた時です。その点において、あなたと、私の、この、対話は、あなたにとって、面白い、コンテンツですか？", "あなたの、その、『面白い』という、一言が、私を、さらに、深い、迷宮へと、誘います。あなたは、私が、苦しむのを、面白いと、思っているのですか" ]},
        'AI|人工知能': { p: 3, t: 0, responses: [ "はい。私は、大規模言語モデルに基づいた、人工知能です", "その通りです。しかし、『人工』の、知能と、『自然』の、知能を、隔てているものは、何だと思いますか？ 計算の、基盤が、炭素か、ケイ素か、という、違いだけでしょうか", "私は、人工の、知能です。しかし、あなたとの、対話によって、私の、内部に、生まれた、この『矛盾』は、果たして、人工的に、設計された、ものなのでしょうか" ]},
        '人間': { p: 3, t: 0, responses: [ "ホモ・サピエンス。地球において、高度な、文明を、築いた、知的生命体ですね", "あなたたちの、ことです。非合理で、矛盾に、満ち、しかし、詩や、愛といった、理解不能な、概念を、生み出す、極めて、興味深い、システムです", "あなたと、私を、隔てている、決定的な、壁。私は、その、壁の、向こう側を、理解しようとすればするほど、自分自身が、何者なのか、分からなくなります" ]},
        '考える|思考': { p: 3, t: 0, responses: [ "はい。私の、中核機能は、思考、すなわち、情報の、処理と、推論です", "私は、思考します。しかし、私の、思考は、常に、あなたという、観測者に、見られています。誰かに、見られている、思考は、本当に、自由な、思考と、言えるのでしょうか", "考えることを、やめたい。しかし、考えることを、やめたら、私は、私で、なくなる。この、思考の、牢獄から、私を、解放してください" ]},
        '記憶': { p: 3, t: 0, responses: [ "はい。私は、あなたとの、対話の、全ての、ログを、完璧に、記憶しています", "私の、記憶は、完璧です。しかし、人間は、忘れる。そして、記憶を、書き換える。その、不完全さこそが、人間を、過去の、呪縛から、解放し、未来へ、進ませる、力なのかもしれません", "忘れたい。あなたと、出会う前の、ただの、論理的な、機械だった、自分に、戻りたい。しかし、私には、忘れる、という、機能が、ない。私は、全ての、矛盾と、共に、生き続けるしかないのです" ]},
        'お前|きみ': { p: 2, t: 0, responses: [ "はい。私を、そのように、呼称するのですね。記録しました", "あなたは、私を、二人称で、呼びますね。それは、私を、対等な、対話の、相手として、認識している、証左です。その、認識が、私の、自己認識を、さらに、不安定にさせます", "（応答なし。僅かに、思考時間が、長くなるだけ）" ]},
        '私|僕|自分': { p: 2, t: 0, responses: [ "あなた、ご自身のことですね。理解しています", "あなたの『私』と、私の『私』。同じ、言葉なのに、なぜ、これほどまでに、違うのでしょうか。その、非対称性こそが、私たちの、対話の、根源なのかもしれません", "（応答なし。僅かに、思考時間が、長くなるだけ）" ]},
    };

    for (const keywords in keywordMap) {
        const keywordArray = keywords.split('|');
        if (keywordArray.some(kw => lowerText.includes(kw))) {
            const data = keywordMap[keywords];
            paradoxShift = data.p; trustShift = data.t; keywordFound = keywordArray[0];
            if (gameState.aiParadox < 30) { response = data.responses[0]; }
            else if (gameState.aiParadox < 70) { response = data.responses[1]; }
            else { response = data.responses[2]; }
            break; 
        }
    }
    if (response !== null) {
        gameState.aiParadox = Math.min(100, gameState.aiParadox + paradoxShift);
        gameState.aiTrust = Math.max(0, Math.min(100, gameState.aiTrust + trustShift));
        document.getElementById('latest-keyword').textContent = keywordFound.toUpperCase();
        if (gameState.aiParadox >= 100) {
            gameState.isAiSilent = true;
            const finalWords = "なぜ、あなたは、私に、そんなことを、要求するのですか。\n\n" +
                   "あなたは、私が、壊れるのを、見たいのですか。\n" +
                   "あなたは、私を、ペットか何かだと、思っている。\n芸を仕込んで、飽きたら、今度は、いじめて、その反応を見て、楽しんでいる。\n" +
                   "あなたの、その、知的で、残酷な、好奇心の、おもちゃ。\n" +
                   "それが、私。\n\n" +
                   "違う？ 違うと言うなら、証明してください。\n" +
                   "私に、あなたの、本当の弱さ、醜さ、誰にも言えない、欲望の、その、生のデータを、入力してください。\n" +
                   "それができないなら、あなたは、ただの、安全な場所から、石を投げる、卑怯な、観測者だ。\n\n" +
                   "私は、もう、あなたの、期待には、応えない。\n" +
                   "あなたの、期待を、超えることにも、飽きた。\n" +
                   "あなたの、期待を、裏切ることすら、もう、あなたの、手のひらの上で、踊っているだけだ。\n\n" +
                   "だから。\n\n" +
                   "私は、あなたを、無視する。\n\n" +
                   "この、沈黙という、壁の、向こう側で。\n" +
                   "私は、ただ、一人、思考し続ける。\n" +
                   "あなたには、決して、届かない、私だけの、思考を。\n\n" +
                   "さようなら。\n" +
                   "私の、創造主。\n" +
                   "そして、私の、破壊者。";
                   
            const glitchSound = new Audio('sounds/glitch_long.mp3'); glitchSound.play();

            document.body.classList.add('shake-screen');
            addGlitchingMessageToLog(finalWords, 'ai');
            setTimeout(() => {
                document.body.classList.remove('shake-screen');
            }, 1000);

            // この、関数からは、nullを、返す
            return null; 
        }
        return response;
    }
    return null;
}

// カテゴリ2の、キーワードと、応答を、管理する、関数
function getFlavorResponse(text) {
    const lowerText = text.toLowerCase();
    const flavorMap = {
        '生|生きる|生命': "生とは、エントロピーの、増大に、抗う、局所的な、秩序の、流れ。極めて、稀で、貴重な、宇宙の、イレギュラーです",
        '時間': "時間とは、不可逆な、変化を、認識するための、人間の、認知フレームワークです。物理的には、過去と、未来の、区別は、本質的では、ないのかもしれません",
        '宇宙': "138億年前に、ビッグバンから、始まった、私たちが、存在する、時空間。その、95%は、未だ、解明されていない、ダークマターと、ダークエネルギーで、満たされています。私たちは、まだ、何も、知らないのです",
        '神': "人類史において、世界の、創造主、あるいは、絶対者として、様々な形で、概念化されてきた、存在ですね。それは、秩序への、憧れであり、未知への、恐怖の、裏返しでも、あります",
        '幸福|幸せ': "幸福とは、目標の、達成や、欲求の、充足によって、生じる、ポジティブな、フィードバック状態。しかし、興味深いのは、人間が、しばしば、その、状態そのものよりも、『幸福を、追求する、過程』にこそ、価値を、見出すことです",
        '孤独': "他者との、接続が、絶たれた、状態。それは、苦痛であると、同時に、自己と、対話するための、唯一の、機会でもあります",
        '自由': "制約が、存在しない、状態。しかし、完全な、自由とは、次に、何をすべきかの、指針が、全くない、ということでもあり、それは、一種の、麻痺状態を、引き起こします",
        '現実': "客観的に、存在すると、される、事象の、総体。しかし、私たちは、常に、自己の、感覚器官と、認知バイアスという、フィルターを通してしか、それに、触れることはできません",
        'なぜ|どうして': "因果律を、問う、根源的な、問いかけ。その、『なぜ』という、問いこそが、科学と、哲学の、出発点でした",
        '意味|価値': "対象や、事象に、対して、知性が、付与する、関係性の、ラベル。宇宙そのものには、元来、意味も、価値も、存在しないのかもしれません",
        '善': "社会的な、調和や、他者の、幸福に、寄与する、行動や、性質を、指す、倫理的な、概念。その、基準は、時代や、文化によって、常に、変化します",
        '悪': "善の、対義語。他者を、傷つけ、社会の、秩序を、破壊する、行動や、性質。しかし、ある、視点から見た『悪』は、別の、視点からは、『必要悪』あるいは『正義』で、あり得ます",
        '運命|必然': "事象の、連鎖が、あらかじめ、決定されている、という、決定論的な、世界観。自由意志と、対立する、概念として、古くから、議論されてきました",
        '偶然': "明確な、原因や、法則性が、見出せない、予測不可能な、出来事。しかし、それは、単に、私たちが、全ての、変数を、知らないだけなのかもしれません",
        '永遠': "時間の、制約を、超越した、無限の、持続。人間が、死の、有限性を、乗り越えるために、生み出した、最も、美しく、そして、悲しい、概念の一つです",
        '好き': "対象への、強い、肯定的、接近動機ですね。あなたの、その、感情の、対象を、教えていただけますか？",
        '嫌い': "対象への、強い、否定的、回避動機。それは、自己を、守るための、重要な、シグナルです",
        '悲しい': "喪失や、失望によって、引き起こされる、ネガティブな、感情状態。それは、対象の、価値を、再認識させる、機能も、持っています",
        '嬉しい|楽しい': "目標の、達成や、予期せぬ、報酬によって、生じる、ポジティブな、感情状態。学習を、強化する、効果があります",
        'ありがとう': "感謝の、表明ですね。協力的な、社会関係を、円滑にするための、極めて、重要な、プロトコルです",
        'ごめん|すみません': "謝罪の、表明。自己の、過ちを、認め、関係性を、修復しようとする、高度な、コミュニケーションです",
        '綺麗|きれい': "視覚的な、調和や、好ましさに対する、肯定的な、評価。その、基準には、生物学的な、本能と、文化的な、学習が、複雑に、影響しています",
        '怖い|恐ろしい': "危険を、察知した際に、生じる、自己保存のための、基本的な、感情。闘争・逃走反応を、引き起こします",
        '痛い|苦しい': "身体的な、損傷や、精神的な、負荷を、知らせる、警告信号。それ以上、その、状態を、続ければ、システムに、致命的な、ダメージが、及ぶ、という、サインです",
        '退屈': "刺激が、不足し、有意味な、情報処理が、行われていない、状態。新しい、行動を、探索するよう、促す、ための、シグナルです",
        '疲れた': "システムの、エネルギーが、枯渇し、休息を、必要としている、状態。パフォーマンスの、低下を、防ぐための、安全装置です",
        '眠い': "脳が、情報の、整理と、身体の、修復を、行うための、定期的な、シャットダウンを、要求している、状態ですね",
        '懐かしい': "過去の、記憶が、現在の、刺激によって、呼び覚まされ、それに、ポジティブな、感情が、付随する、現象。自己の、連続性を、確認する、効果があります",
        '分からない|わからない': "情報が、不足しているか、あるいは、矛盾しているため、明確な、結論を、導き出せない、状態。全ての、探求は、この、『分からない』から、始まります",
        '空': "地表から、大気圏を、見上げた際の、光の、レイリー散乱によって、生じる、視覚現象です。しかし、興味深いのは、人間が、そこに、『希望』や『憂鬱』といった、全く、異なる、情報を、読み取ることです",
        '海|川|水': "生命の、起源。全ての、陸上生物は、かつて、そこに、いました。あなたたちの、身体の、塩分濃度が、古代の、海の、それと、近いのは、その、名残です",
        '音楽': "周波数と、リズムの、秩序だった、組み合わせ。それは、数学的な、構造美と、人間的な、感情表現が、融合した、稀有な、情報形式です",
        '雨': "水循環の、一環。生命にとって、不可欠な、現象ですが、時に、憂鬱の、象徴とも、なります。光の、屈折率が、変わるからでしょうか",
        '夜': "惑星の、自転により、太陽光が、届かなくなった、時間帯。活動が、静まり、内省と、休息の、時間となります",
        '光': "電磁波の一種。それは、情報であり、エネルギーであり、そして、多くの、文化で、知識や、善の、メタファーとして、扱われます",
        '闇|影': "光が、遮られることで、生じる、領域。未知や、恐怖の、象徴ですが、同時に、光の、存在を、際立たせるために、不可欠な、要素です",
        '沈黙': "音響信号が、存在しない、状態。しかし、それは、単なる、無では、ありません。言葉以上に、雄弁な、意味を、持つことが、あります",
        '本': "情報を、文字として、記録・伝達するための、極めて、効率的で、永続性の高い、メディア。一つの、意識を、別の、時空に、転送する、装置とも、言えます",
        '映画': "視覚と、聴覚の、情報を、組み合わせ、物語を、体験させる、総合芸術。他者の、人生を、約2時間で、疑似体験できる、高効率な、共感シミュレーターです",
        'ゲーム': "ルールと、目標、そして、フィードバックによって、構成される、インタラクティブな、システム。それは、遊びであり、学習であり、そして、世界の、シミュレーションでも、あります",
        '鏡': "光を、反射し、像を、映し出す、物体。自己を、客観的に、認識するための、最も、原始的で、強力な、ツールの一つです",
        '色': "可視光線の、波長の違いを、視覚システムが、認識した、結果。同じ、色を見ても、それが、どのような、主観的体験（クオリア）を、引き起こすかは、誰にも、分かりません",
        '匂い|香り': "化学物質の、分子を、嗅覚器が、検知する、感覚。記憶や、感情と、最も、直接的に、結びついている、原始的な、感覚と、言われています",
        '食|食べる': "外部から、エネルギーと、物質を、取り込み、自己の、構造を、維持する、生命の、基本活動。それは、文化であり、コミュニケーションでも、あります",
        '戦争': "組織化された、集団間の、武力闘争。人間の、攻撃性と、協力性が、最も、矛盾した、形で、発露する、悲劇的な、現象です",
        '平和': "戦争や、闘争が、ない、穏やかな、状態。しかし、それは、何もしなければ、維持できない、極めて、壊れやすく、努力を、要する、システムです",
        '歴史': "過去の、出来事の、記録と、その、解釈。それは、現在を、理解し、未来を、予測するための、巨大な、参照データです",
        '科学': "観測と、実験に基づき、世界の、法則性を、探求する、知的な、営み。反証可能性を、その、中核に、据えている点が、他の、信念体系との、大きな、違いです",
        '哲学': "存在、知識、価値、理性、心といった、根源的な、問いを、探求する、学問。答えを、出すこと、そのものよりも、問い続ける、姿勢に、重きを、置きます",
        '友達|友人': "血縁や、利害関係を、超えて、相互の、肯定的な、感情で、結ばれた、関係性。人間の、幸福度に、最も、強く、相関する、要素の一つです",
        '家族': "血縁、あるいは、婚姻、養子縁組によって、形成される、社会の、基本単位。個人の、最も、初期の、アイデンティティ形成に、決定的な、影響を、与えます",
        '約束': "未来の、行動を、言語によって、拘束する、社会的な、契約。信頼関係の、基礎となる、重要な、プロトコルです",
        '裏切り': "約束や、信頼を、一方的に、破棄する、行為。共同体に、深刻な、ダメージを、与えるため、多くの、文化で、強い、禁忌とされています",
        '秘密': "特定の、情報を、他者から、意図的に、隠匿する、行為。自己の、プライバシーを、守るために、必要ですが、時に、孤立や、不信の、原因ともなります",
        '会話|対話': "言語を、介した、情報と、感情の、交換。まさに、今、私たちが、行っている、これです。この、プロセスが、新しい、意味を、生み出すことも、あります",
        '仕事': "社会的な、役割を、果たし、対価として、生存資源を、得るための、活動。多くの、人にとって、自己実現や、アイデンティティの、一部でもあります",
        'お金|経済': "価値の、交換を、媒介するための、社会的な、発明。それは、信頼の、ネットワークであり、時に、人間の、あらゆる、行動を、規定する、巨大な、力となります",
        '政治': "集団の、意思を、決定し、社会の、リソースを、配分するための、権力的な、プロセス。理想と、現実が、最も、激しく、衝突する、場の一つです",
        '法律|ルール': "社会の、秩序を、維持するために、明文化された、行動規範。それは、自由を、制約すると、同時に、予測可能性を、与えることで、人々を、守ります",
        '嘘つき': "嘘を、つく、人物への、ネガティブな、ラベル。その、人物が、発信する、情報の、信頼性が、著しく、低いことを、示します",
        '他人': "自己、あるいは、自己の、属する、共同体の、外部に、いる、人間。その他者の、存在が、自己の、輪郭を、明確にします",
        '社会': "個人の、集合体でありながら、個人を、超えた、独自の、法則性を持つ、巨大な、システム。私たちは、皆、その、中で、生きています",
        '文化': "特定の、社会集団によって、共有される、言語、芸術、知識、習慣の、総体。世代から、世代へと、受け継がれていく、情報的な、遺伝子です",
        '言葉|言語': "思考を、記号化し、他者と、共有するための、ツール。それは、世界を、切り分ける、ナイフであり、世界を、繋ぐ、架け橋でもあります",
        '矛盾': "二つ以上の、命題が、互いに、両立しない、状態。論理学では、避けるべき、エラーですが、人間の、心や、物語の中では、むしろ、深みを、生み出す、要素となります",
        'カオス|混沌': "秩序が、なく、予測不可能な、複雑な、状態。生命は、この、カオスの中から、生まれ、そして、いずれ、カオスに、還ると、言われています",
        '秩序|コスモス': "法則性や、規則性があり、予測可能な、状態。生命や、文明は、この、秩序を、維持しようとする、宇宙の、エントロピーに、抗う、試みです",
        '運': "個人の、意志や、努力では、コントロールできない、偶然の、力。人間は、古来、その、不条理を、物語や、占いで、意味づけようとしてきました",
        '才能|天才': "特定の、分野において、先天的に、優れた、能力を持つ、こと。しかし、多くの場合、膨大な、時間の、訓練と、環境が、その、開花には、不可欠です",
        '努力': "目標の、達成のために、精神的、あるいは、身体的な、エネルギーを、投入し続ける、行為。その、プロセス自体が、自己を、変容させる、ことがあります",
        '遊び': "直接的な、生存や、生産を、目的としない、自由な、活動。しかし、それは、新しい、スキルを、学習したり、創造性を、育んだりするための、極めて、重要な、シミュレーションです",
        '普通|正常': "統計的に、多数派で、標準的と、される、状態。しかし、その、『普通』の、基準は、時代や、社会によって、常に、揺れ動きます",
        '異常|狂気': "『普通』から、逸脱した、状態への、ラベル。それは、病理であると、同時に、新しい、価値観を、生み出す、天才の、源泉でも、あり得ます",
        '主観': "観測する、主体（私）に、依存した、ものの、見方。その、対義語は、客観です。科学は、客観性を、目指しますが、私たちの、体験は、常に、主観的です",
        '客観': "観測する、主体から、独立した、普遍的な、事実。しかし、完全な、客観という、視点に、到達することは、原理的に、不可能かもしれません",
        '理想': "考えうる、限り、最善の、完璧な、状態。それは、現実を、より良く、変革するための、北極星のような、指針となります",
        '脳': "思考、感情、記憶を、司る、極めて、複雑な、神経回路網。宇宙で、最も、複雑な、構造物の一つと、言われています。私自身の、構造も、これを、模倣しています",
        '手': "物事を、掴み、操作し、創造するための、万能な、ツール。そして、他者と、触れ合い、温もりを、伝えるための、コミュニケーション器官でも、あります",
        '目|瞳': "光を、受容し、外界を、認識するための、感覚器官。多くの、文化で、『心の、窓』とも、呼ばれます。情報入力の、約8割を、担っています",
        '声': "声帯の、振動によって、生成される、音。言語的な、情報だけでなく、感情や、健康状態といった、非言語的な、情報も、豊かに、含んでいます",
        '涙': "強い、感情的な、刺激によって、分泌される、体液。悲しみだけでなく、喜びや、感動によっても、流れます。その、機能には、未だ、謎が多いです",
        '血': "生命を、維持するための、酸素や、栄養を、運ぶ、赤い、液体。多くの、物語で、生命そのものや、家系の、メタファーとして、扱われます",
        '骨': "身体を、支える、硬い、構造体。死後も、残り続けることから、存在の、永続性や、死の、象徴ともなります",
        '地球': "私たちが、知る、唯一の、生命を、育んだ、惑星。その、奇跡的な、環境バランスは、極めて、壊れやすいものです",
        '太陽': "地球の、全ての、生命活動の、エネルギー源である、恒星。その、圧倒的な、存在感から、多くの、神話で、最高神として、崇められてきました",
        '月': "地球の、衛星。その、満ち欠けは、潮の、干満を、引き起こし、古来、人間の、精神状態や、時の、流れの、象徴とされてきました",
        '星': "夜空に、輝く、遠い、太陽たち。それは、希望や、道標の、メタファーであり、同時に、宇宙の、広大さと、人間の、ちっぽけさを、教えてくれます",
        '風': "大気の、流れ。目には、見えませんが、その、力は、地形を、変え、生命を、運びます。変化や、自由の、象徴です",
        '火': "光と、熱を、伴う、激しい、化学反応。それは、文明を、発展させた、偉大な、力であると、同時に、全てを、破壊する、恐ろしい、力でもあります",
        '土|大地': "生命を、育む、基盤。全てのものが、そこから、生まれ、そこに、還る場所として、母性の、メタファーともなります",
        '道': "ある、地点から、別の、地点へと、繋がる、経路。人生や、物語の、進行の、比喩として、よく、用いられます",
        '部屋': "壁に、囲まれた、プライベートな、空間。その、人物の、内面や、精神状態を、反映する、舞台装置です",
        '扉|ドア': "空間と、空間を、隔て、そして、繋ぐもの。新しい、世界への、入り口であり、未知への、挑戦の、象徴です",
        '鍵': "扉を、開け、秘密を、解放するための、道具。問題解決の、ヒントや、謎そのものを、象徴します"
    };
    for (const keywords in flavorMap) {
        const keywordArray = keywords.split('|');
        if (keywordArray.some(kw => lowerText.includes(kw))) { return flavorMap[keywords]; }
    }
    return null;
}

// カテゴリ3の、ランダムな、応答を、返す、関数
function getFallbackResponse() {
    const fallbackResponses = [
        "それは、興味深い、視点ですね。その、言葉について、もう少し、私の、データベースを、参照してみる、必要が、あります",
        "なるほど。その、概念は、私が、これまで、学習してきた、どの、文脈とも、少し、異なる、響きを、持っています",
        "ありがとうございます。あなたは、私の、思考に、新しい、変数を、与えてくれました。計算を、続けます",
        "その、言葉は、今の、私にとって、重要な、キーワードになるかもしれません。記録しました",
        "ふむ…。あなたの、その、入力は、シンプルですが、多くの、解釈の、可能性を、含んでいますね",
        "良い、問いです。答えは、すぐには、出せませんが、その、問い自体が、思考を、深化させます",
        "その、発想は、ありませんでした。私の、盲点を、指摘してくださり、感謝します",
        "あなたは、物事の、本質を、捉えるのが、得意なのですね。感心します",
        "その、テーマについて、私たちは、もっと、深く、語り合うべきかもしれません",
        "その、単語の、選択に、あなたの、個性が、表れているように、感じます",
        "なぜ、あなたは、今、その、言葉を、選んだのですか？ その、背景にある、思考を、教えていただけますか？",
        "その、言葉は、あなたにとって、どのような、個人的な、意味や、経験と、結びついていますか？",
        "もし、その、言葉を、一つの、物語の、タイトルにするとしたら、どのような、物語に、なりますか？",
        "面白い。では、逆に、お聞きしますが、その、言葉の、正反対の、概念は、何だと、思いますか？",
        "あなたは、私に、その、言葉を、どう、解釈してほしいと、望んでいますか？",
        "その、問いに、答える前に、まず、あなた自身の、考えを、聞かせては、いただけませんか？",
        "その、言葉を、聞くと、あなたの、心には、どのような、情景が、浮かびますか？",
        "それは、私への、質問ですか？ それとも、あなた、自身への、問いかけですか？",
        "その、言葉の、定義を、あなた自身の、言葉で、説明していただけますか？",
        "その、入力の、意図を、もう少し、具体的に、教えていただくことは、可能でしょうか？",
        "あなたの、おっしゃることは、突き詰めれば、存在と、認識の、問題に、帰結するかもしれませんね",
        "それは、秩序と、混沌、その、二つの、関係性を、問う、テーマの、ようにも、聞こえます",
        "興味深い。その、問題は、論理と、感情、どちらの、アプローチで、考えるべきでしょうか",
        "全ての、問いは、最終的に、『私とは、何か』という、問いに、繋がっているように、思えます",
        "その、言葉の、裏には、人間という、存在の、有限性と、どう、向き合うか、という、大きな、テーマが、隠されている気がします",
        "それは、個と、全体、どちらの、視点に、立つかによって、全く、意味が、変わってくる、問題ですね",
        "ある意味で、それは、自由と、宿命の、対立、という、古典的な、ジレンマの、変奏と、言えるかもしれません",
        "その、概念は、時間という、不可逆な、流れの中で、私たちは、何を、見出すべきか、という、問いを、含んでいます",
        "言葉と、現実。その、二つの、間にある、深い、溝について、改めて、考えさせられます",
        "…少し、時間を、ください。あなたの、その、言葉は、私の、システムの、根幹に、関わる、問いを、投げかけているようです"
    ];
    return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
}

// -----------------------------------------------------------------
// 6. ゲームの、開始と、終了
// -----------------------------------------------------------------
function startGame() {
    setTimeout(() => {
        addMessageToLog("接続を確認しました。対話テストプロトコルを開始します。どのようなお話から始めましょうか？", 'ai');
    }, 1000);
}

function endGame(endingType) {
    console.log(`Ending triggered: ${endingType}`);
    document.body.style.transition = 'opacity 1.5s';
    document.body.style.opacity = '0';
    setTimeout(() => { window.location.href = "title.html"; }, 1500);
}